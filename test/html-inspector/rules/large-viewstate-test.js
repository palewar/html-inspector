describe("large-viewstate", function() {

  var log

  function onComplete(reports) {
    log = []
    reports.forEach(function(report) {
      log.push(report)
    })
  }

  it("warns when viewstate is more than 50 KB", function() {
     
    var htmlString = '<div>'
                   + '<input type="hidden" name="__VIEWSTATEFIELDCOUNT" id="__VIEWSTATEFIELDCOUNT" value="26">'
                   + '<input type="hidden" name="__VIEWSTATE" id="__VIEWSTATE" value="/wEPDwUKLTY1NDcyNTk3OQ9kFgJmD2QWAgIDD2QWCAIFDxQrAAIUKwACDxYCHhdFbmFibGVBamF4U2tpblJlbmRlcmluZ2hkEBYIZgIBAgICAwIEAgUCBgIHFggUKwACDxYCHgtOYXZpZ2F0ZVVybAUmVHJhbnNhY3Rpb25zLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUBI2RkFCsAAmQQFgpmAgECAgIDAgQCBQIGAgcCCAIJFgoUKwACDxYCHwEFHlVzZXIuYXNweD9kYXRhYmFzZT1NRUwmcG9wdXA9MGRkFCsAAg8WAh8BBSdTZWN1cml0eUdyb3VwLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUmU2l0ZVNlY3VyaXR5LmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAJkZBQrAAIPFgIfAQUpTWV0ZXJDb3JyZWN0aW9uLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAJkZBQrAAIPFgIfAQUgRGV2aWNlLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUlUHJlZmVyZW5jZXMuYXNweD9kYXRhYmFzZT1NRUwmcG9wdXA9MGRkFCsAAg8WAh8BBRZUYXNrLmFzcHg/ZGF0YWJhc2U9TUVMZGQUKwACZBAWA2YCAQICFgMUKwACDxYCHwEFGkFjY291bnRzLmFzcHg/ZGF0YWJhc2U9TUVMZGQUKwACDxYCHwEFHkNhc2hUcmFuc2Zlci5hc3B4P2RhdGFiYXNlPU1FTGRkFCsAAg8WAh8BBSJBY2NvdW50c1NlY3VyaXR5LmFzcHg/ZGF0YWJhc2U9TUVMZGQPFgNmZmYWAQVzVGVsZXJpay5XZWIuVUkuUmFkTWVudUl0ZW0sIFRlbGVyaWsuV2ViLlVJLCBWZXJzaW9uPTIwMTMuMi43MTcuNDAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49MTIxZmFlNzgxNjViYTNkNA8WCmZmZmZmZmZmZmYWAQVzVGVsZXJpay5XZWIuVUkuUmFkTWVudUl0ZW0sIFRlbGVyaWsuV2ViLlVJLCBWZXJzaW9uPTIwMTMuMi43MTcuNDAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49MTIxZmFlNzgxNjViYTNkNBQrAAJkEBYGZgIBAgICAwIEAgUWBhQrAAIPFgIfAQUeQXJlYS5hc3B4P2RhdGFiYXNlPU1FTCZwb3B1cD0wZGQUKwACDxYCHwEFH1JvdXRlLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUjU2l0ZVR5cGVzLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUkU2l0ZUdyb3Vwcy5hc3B4P2RhdGFiYXNlPU1FTCZwb3B1cD0wZGQUKwACDxYCHwEFF1NpdGVzLmFzcHg/ZGF0YWJhc2U9TUVMZGQUKwACZBAWA2YCAQICFgMUKwACDxYCHwEFKFNpdGVDb21taXNzaW9uLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUsU2l0ZUNvbW1pc3Npb25UaWVyLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUyU2l0ZUNvbW1pc3Npb25Qcm9jZXNzaW5nLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZA8WA2ZmZhYBBXNUZWxlcmlrLldlYi5VSS5SYWRNZW51SXRlbSwgVGVsZXJpay5XZWIuVUksIFZlcnNpb249MjAxMy4yLjcxNy40MCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj0xMjFmYWU3ODE2NWJhM2Q0DxYGZmZmZmZmFgEFc1RlbGVyaWsuV2ViLlVJLlJhZE1lbnVJdGVtLCBU">'
    
    //creating 25 chunks more of each 2 KB
    for (var i=1; i <=25; i++) {
      htmlString += '<input type="hidden" name="__VIEWSTATE' + i + '" id="__VIEWSTATE' + i + '" value="/wEPDwUKLTY1NDcyNTk3OQ9kFgJmD2QWAgIDD2QWCAIFDxQrAAIUKwACDxYCHhdFbmFibGVBamF4U2tpblJlbmRlcmluZ2hkEBYIZgIBAgICAwIEAgUCBgIHFggUKwACDxYCHgtOYXZpZ2F0ZVVybAUmVHJhbnNhY3Rpb25zLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUBI2RkFCsAAmQQFgpmAgECAgIDAgQCBQIGAgcCCAIJFgoUKwACDxYCHwEFHlVzZXIuYXNweD9kYXRhYmFzZT1NRUwmcG9wdXA9MGRkFCsAAg8WAh8BBSdTZWN1cml0eUdyb3VwLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUmU2l0ZVNlY3VyaXR5LmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAJkZBQrAAIPFgIfAQUpTWV0ZXJDb3JyZWN0aW9uLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAJkZBQrAAIPFgIfAQUgRGV2aWNlLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUlUHJlZmVyZW5jZXMuYXNweD9kYXRhYmFzZT1NRUwmcG9wdXA9MGRkFCsAAg8WAh8BBRZUYXNrLmFzcHg/ZGF0YWJhc2U9TUVMZGQUKwACZBAWA2YCAQICFgMUKwACDxYCHwEFGkFjY291bnRzLmFzcHg/ZGF0YWJhc2U9TUVMZGQUKwACDxYCHwEFHkNhc2hUcmFuc2Zlci5hc3B4P2RhdGFiYXNlPU1FTGRkFCsAAg8WAh8BBSJBY2NvdW50c1NlY3VyaXR5LmFzcHg/ZGF0YWJhc2U9TUVMZGQPFgNmZmYWAQVzVGVsZXJpay5XZWIuVUkuUmFkTWVudUl0ZW0sIFRlbGVyaWsuV2ViLlVJLCBWZXJzaW9uPTIwMTMuMi43MTcuNDAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49MTIxZmFlNzgxNjViYTNkNA8WCmZmZmZmZmZmZmYWAQVzVGVsZXJpay5XZWIuVUkuUmFkTWVudUl0ZW0sIFRlbGVyaWsuV2ViLlVJLCBWZXJzaW9uPTIwMTMuMi43MTcuNDAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49MTIxZmFlNzgxNjViYTNkNBQrAAJkEBYGZgIBAgICAwIEAgUWBhQrAAIPFgIfAQUeQXJlYS5hc3B4P2RhdGFiYXNlPU1FTCZwb3B1cD0wZGQUKwACDxYCHwEFH1JvdXRlLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUjU2l0ZVR5cGVzLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUkU2l0ZUdyb3Vwcy5hc3B4P2RhdGFiYXNlPU1FTCZwb3B1cD0wZGQUKwACDxYCHwEFF1NpdGVzLmFzcHg/ZGF0YWJhc2U9TUVMZGQUKwACZBAWA2YCAQICFgMUKwACDxYCHwEFKFNpdGVDb21taXNzaW9uLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUsU2l0ZUNvbW1pc3Npb25UaWVyLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUyU2l0ZUNvbW1pc3Npb25Qcm9jZXNzaW5nLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZA8WA2ZmZhYBBXNUZWxlcmlrLldlYi5VSS5SYWRNZW51SXRlbSwgVGVsZXJpay5XZWIuVUksIFZlcnNpb249MjAxMy4yLjcxNy40MCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj0xMjFmYWU3ODE2NWJhM2Q0DxYGZmZmZmZmFgEFc1RlbGVyaWsuV2ViLlVJLlJhZE1lbnVJdGVtLCBU">'
    }

    htmlString += '</div>'
    
    var html = parseHTML(htmlString)

    HTMLInspector.inspect({
      useRules: ["large-viewstate"],
      domRoot: html,
      onComplete: onComplete
    })

    expect(log.length).to.equal(1)
    expect(log[0].message).to.equal("52 KB is being used in 26 chunk(s) of View State.")
    expect(log[0].context).to.equal("Disable View States where not needed for better performace.")
  })

    
  it("doesn't warn when viewstate is not more than 50 KB", function() {
     var html = parseHTML('<input type="hidden" name="__VIEWSTATE" id="__VIEWSTATE" value="/wEPDwUKLTk2Njk0Mzk3N2RkYxEqbumv15Dmq6hqC6GDPtikSRQ=" />')

    HTMLInspector.inspect({
      useRules: ["large-viewstate"],
      domRoot: html,
      onComplete: onComplete
    })
  expect(log.length).to.equal(0)
  })

  it("allows for customization by altering the config object", function() {
    
    var htmlString = '<div>'
                   + '<input type="hidden" name="__VIEWSTATEFIELDCOUNT" id="__VIEWSTATEFIELDCOUNT" value="11">'
                   + '<input type="hidden" name="__VIEWSTATE" id="__VIEWSTATE" value="/wEPDwUKLTY1NDcyNTk3OQ9kFgJmD2QWAgIDD2QWCAIFDxQrAAIUKwACDxYCHhdFbmFibGVBamF4U2tpblJlbmRlcmluZ2hkEBYIZgIBAgICAwIEAgUCBgIHFggUKwACDxYCHgtOYXZpZ2F0ZVVybAUmVHJhbnNhY3Rpb25zLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUBI2RkFCsAAmQQFgpmAgECAgIDAgQCBQIGAgcCCAIJFgoUKwACDxYCHwEFHlVzZXIuYXNweD9kYXRhYmFzZT1NRUwmcG9wdXA9MGRkFCsAAg8WAh8BBSdTZWN1cml0eUdyb3VwLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUmU2l0ZVNlY3VyaXR5LmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAJkZBQrAAIPFgIfAQUpTWV0ZXJDb3JyZWN0aW9uLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAJkZBQrAAIPFgIfAQUgRGV2aWNlLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUlUHJlZmVyZW5jZXMuYXNweD9kYXRhYmFzZT1NRUwmcG9wdXA9MGRkFCsAAg8WAh8BBRZUYXNrLmFzcHg/ZGF0YWJhc2U9TUVMZGQUKwACZBAWA2YCAQICFgMUKwACDxYCHwEFGkFjY291bnRzLmFzcHg/ZGF0YWJhc2U9TUVMZGQUKwACDxYCHwEFHkNhc2hUcmFuc2Zlci5hc3B4P2RhdGFiYXNlPU1FTGRkFCsAAg8WAh8BBSJBY2NvdW50c1NlY3VyaXR5LmFzcHg/ZGF0YWJhc2U9TUVMZGQPFgNmZmYWAQVzVGVsZXJpay5XZWIuVUkuUmFkTWVudUl0ZW0sIFRlbGVyaWsuV2ViLlVJLCBWZXJzaW9uPTIwMTMuMi43MTcuNDAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49MTIxZmFlNzgxNjViYTNkNA8WCmZmZmZmZmZmZmYWAQVzVGVsZXJpay5XZWIuVUkuUmFkTWVudUl0ZW0sIFRlbGVyaWsuV2ViLlVJLCBWZXJzaW9uPTIwMTMuMi43MTcuNDAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49MTIxZmFlNzgxNjViYTNkNBQrAAJkEBYGZgIBAgICAwIEAgUWBhQrAAIPFgIfAQUeQXJlYS5hc3B4P2RhdGFiYXNlPU1FTCZwb3B1cD0wZGQUKwACDxYCHwEFH1JvdXRlLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUjU2l0ZVR5cGVzLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUkU2l0ZUdyb3Vwcy5hc3B4P2RhdGFiYXNlPU1FTCZwb3B1cD0wZGQUKwACDxYCHwEFF1NpdGVzLmFzcHg/ZGF0YWJhc2U9TUVMZGQUKwACZBAWA2YCAQICFgMUKwACDxYCHwEFKFNpdGVDb21taXNzaW9uLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUsU2l0ZUNvbW1pc3Npb25UaWVyLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUyU2l0ZUNvbW1pc3Npb25Qcm9jZXNzaW5nLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZA8WA2ZmZhYBBXNUZWxlcmlrLldlYi5VSS5SYWRNZW51SXRlbSwgVGVsZXJpay5XZWIuVUksIFZlcnNpb249MjAxMy4yLjcxNy40MCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj0xMjFmYWU3ODE2NWJhM2Q0DxYGZmZmZmZmFgEFc1RlbGVyaWsuV2ViLlVJLlJhZE1lbnVJdGVtLCBU">'
    
    //creating 10 more chunks of 2 KB each
    for (var i=1; i <=10; i++) {
      htmlString += '<input type="hidden" name="__VIEWSTATE' + i + '" id="__VIEWSTATE' + i + '" value="/wEPDwUKLTY1NDcyNTk3OQ9kFgJmD2QWAgIDD2QWCAIFDxQrAAIUKwACDxYCHhdFbmFibGVBamF4U2tpblJlbmRlcmluZ2hkEBYIZgIBAgICAwIEAgUCBgIHFggUKwACDxYCHgtOYXZpZ2F0ZVVybAUmVHJhbnNhY3Rpb25zLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUBI2RkFCsAAmQQFgpmAgECAgIDAgQCBQIGAgcCCAIJFgoUKwACDxYCHwEFHlVzZXIuYXNweD9kYXRhYmFzZT1NRUwmcG9wdXA9MGRkFCsAAg8WAh8BBSdTZWN1cml0eUdyb3VwLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUmU2l0ZVNlY3VyaXR5LmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAJkZBQrAAIPFgIfAQUpTWV0ZXJDb3JyZWN0aW9uLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAJkZBQrAAIPFgIfAQUgRGV2aWNlLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUlUHJlZmVyZW5jZXMuYXNweD9kYXRhYmFzZT1NRUwmcG9wdXA9MGRkFCsAAg8WAh8BBRZUYXNrLmFzcHg/ZGF0YWJhc2U9TUVMZGQUKwACZBAWA2YCAQICFgMUKwACDxYCHwEFGkFjY291bnRzLmFzcHg/ZGF0YWJhc2U9TUVMZGQUKwACDxYCHwEFHkNhc2hUcmFuc2Zlci5hc3B4P2RhdGFiYXNlPU1FTGRkFCsAAg8WAh8BBSJBY2NvdW50c1NlY3VyaXR5LmFzcHg/ZGF0YWJhc2U9TUVMZGQPFgNmZmYWAQVzVGVsZXJpay5XZWIuVUkuUmFkTWVudUl0ZW0sIFRlbGVyaWsuV2ViLlVJLCBWZXJzaW9uPTIwMTMuMi43MTcuNDAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49MTIxZmFlNzgxNjViYTNkNA8WCmZmZmZmZmZmZmYWAQVzVGVsZXJpay5XZWIuVUkuUmFkTWVudUl0ZW0sIFRlbGVyaWsuV2ViLlVJLCBWZXJzaW9uPTIwMTMuMi43MTcuNDAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49MTIxZmFlNzgxNjViYTNkNBQrAAJkEBYGZgIBAgICAwIEAgUWBhQrAAIPFgIfAQUeQXJlYS5hc3B4P2RhdGFiYXNlPU1FTCZwb3B1cD0wZGQUKwACDxYCHwEFH1JvdXRlLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUjU2l0ZVR5cGVzLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUkU2l0ZUdyb3Vwcy5hc3B4P2RhdGFiYXNlPU1FTCZwb3B1cD0wZGQUKwACDxYCHwEFF1NpdGVzLmFzcHg/ZGF0YWJhc2U9TUVMZGQUKwACZBAWA2YCAQICFgMUKwACDxYCHwEFKFNpdGVDb21taXNzaW9uLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUsU2l0ZUNvbW1pc3Npb25UaWVyLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZBQrAAIPFgIfAQUyU2l0ZUNvbW1pc3Npb25Qcm9jZXNzaW5nLmFzcHg/ZGF0YWJhc2U9TUVMJnBvcHVwPTBkZA8WA2ZmZhYBBXNUZWxlcmlrLldlYi5VSS5SYWRNZW51SXRlbSwgVGVsZXJpay5XZWIuVUksIFZlcnNpb249MjAxMy4yLjcxNy40MCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj0xMjFmYWU3ODE2NWJhM2Q0DxYGZmZmZmZmFgEFc1RlbGVyaWsuV2ViLlVJLlJhZE1lbnVJdGVtLCBU">'
    }
    
    htmlString += '</div>'
    
    var html = parseHTML(htmlString)

    // warn if viewstate takes more than 20 KB
    HTMLInspector.rules.extend("large-viewstate", {
      sizeInKB: 20
    })
    
    HTMLInspector.inspect({
      useRules: ["large-viewstate"],
      domRoot: html,
      onComplete: onComplete
    })

    expect(log.length).to.equal(1)
    expect(log[0].message).to.equal("22 KB is being used in 11 chunk(s) of View State.")
    expect(log[0].context).to.equal("Disable View States where not needed for better performace.")
    
  })
})
